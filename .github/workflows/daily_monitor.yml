name: Daily Sitemap Check

on:
  schedule:
    # Staggered cron times to appear less predictable (Pacific-friendly windows)
    # Primary: 66% - Early morning Pacific (midnight-5am PT = 8-13 UTC)
    - cron: '17 8 * * *'   # ~12:17 AM PT
    - cron: '43 9 * * *'   # ~1:43 AM PT
    - cron: '28 10 * * *'  # ~2:28 AM PT
    - cron: '52 11 * * *'  # ~3:52 AM PT
    - cron: '11 12 * * *'  # ~4:11 AM PT
    # Secondary: 22% - Morning Pacific (5am-noon PT = 13-20 UTC)  
    - cron: '34 14 * * 1'  # ~6:34 AM PT (Mondays)
    - cron: '19 17 * * 4'  # ~9:19 AM PT (Thursdays)
    # Tertiary: 12% - Afternoon Pacific (noon-midnight PT = 20-8 UTC)
    - cron: '47 22 * * 3'  # ~2:47 PM PT (Wednesdays)
  workflow_dispatch:  # Allow manual triggering

jobs:
  run-sitemap-check:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Random startup jitter (0-15 min)
        run: |
          JITTER=$((RANDOM % 900))
          echo "Waiting ${JITTER} seconds before starting..."
          sleep $JITTER
      
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
      
      - name: Run sitemap check
        run: python -m src.main
      
      - name: Commit and push if changed
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add data/
          if ! git diff --staged --quiet; then
            git commit -m "Update sitemap data [skip ci]"
            git push
          else
            echo "No data changes to commit."
          fi
